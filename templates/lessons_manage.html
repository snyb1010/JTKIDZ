{% extends "base.html" %}

{% block title %}Lesson Management - JT KIDZ{% endblock %}

{% block content %}
<div class="mb-6">
    <div class="flex justify-between items-center">
        <div>
            <h1 class="text-3xl font-bold text-gray-800">üìö Lesson Management</h1>
            <p class="text-gray-600">Track lesson start dates for all sites</p>
        </div>
        <!-- Quarter Selector -->
        <div class="flex gap-2">
            <a href="{{ url_for('lessons.manage_lessons', quarter='1') }}" 
               class="px-4 py-2 rounded-lg font-semibold {% if selected_quarter == '1' %}bg-blue-600 text-white{% else %}bg-gray-200 text-gray-700 hover:bg-gray-300{% endif %}">
                Q1
            </a>
            <a href="{{ url_for('lessons.manage_lessons', quarter='2') }}" 
               class="px-4 py-2 rounded-lg font-semibold {% if selected_quarter == '2' %}bg-blue-600 text-white{% else %}bg-gray-200 text-gray-700 hover:bg-gray-300{% endif %}">
                Q2
            </a>
            <a href="{{ url_for('lessons.manage_lessons', quarter='3') }}" 
               class="px-4 py-2 rounded-lg font-semibold {% if selected_quarter == '3' %}bg-blue-600 text-white{% else %}bg-gray-200 text-gray-700 hover:bg-gray-300{% endif %}">
                Q3
            </a>
            <a href="{{ url_for('lessons.manage_lessons', quarter='4') }}" 
               class="px-4 py-2 rounded-lg font-semibold {% if selected_quarter == '4' %}bg-blue-600 text-white{% else %}bg-gray-200 text-gray-700 hover:bg-gray-300{% endif %}">
                Q4
            </a>
        </div>
    </div>
</div>

{% for data in lesson_data %}
<div class="bg-white rounded-lg shadow-md p-6 mb-6">
    <div class="flex justify-between items-center mb-4">
        <div class="flex items-center gap-3">
            <button onclick="toggleCalendar('{{ data.site|replace(' ', '_') }}')" 
                    class="text-gray-600 hover:text-gray-800 focus:outline-none">
                <svg id="icon-{{ data.site|replace(' ', '_') }}" class="w-6 h-6 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                </svg>
            </button>
            <h2 class="text-2xl font-bold text-gray-800">{{ data.site }}</h2>
        </div>
        <span class="bg-purple-100 text-purple-800 px-4 py-2 rounded-full font-bold">
            Current: Lesson {{ data.current_lesson }}
        </span>
    </div>
    
    <!-- Collapsible Calendar Section -->
    <div id="calendar-{{ data.site|replace(' ', '_') }}" class="calendar-section">
        <!-- Calendar Quarter Header -->
        <div class="text-center mb-4">
            <h3 class="text-xl font-bold text-gray-700">
                {% if selected_quarter == '1' %}Q1 2026 (Jan - Mar)
                {% elif selected_quarter == '2' %}Q2 2026 (Apr - Jun)
                {% elif selected_quarter == '3' %}Q3 2026 (Jul - Sep)
                {% else %}Q4 2026 (Oct - Dec)
                {% endif %}
            </h3>
        </div>
        
        <!-- Calendars Grid (3 months) -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            {% for month in data.months %}
            <div class="border border-gray-200 rounded-lg p-3">
                <h3 class="text-center font-bold text-gray-700 mb-2">{{ month.name }} 2026</h3>
            <table class="w-full text-xs">
                <thead>
                    <tr class="text-gray-500">
                        <th class="text-center py-1">Su</th>
                        <th class="text-center py-1">Mo</th>
                        <th class="text-center py-1">Tu</th>
                        <th class="text-center py-1">We</th>
                        <th class="text-center py-1">Th</th>
                        <th class="text-center py-1">Fr</th>
                        <th class="text-center py-1">Sa</th>
                    </tr>
                </thead>
                <tbody>
                    {% for week in month.weeks %}
                    <tr>
                        {% for day in week %}
                        <td class="text-center py-1 relative">
                            {% if day == 0 %}
                            <span class="text-gray-300"></span>
                            {% else %}
                            <div class="relative">
                                <span class="{% if day in month.lesson_markers %}font-bold text-purple-600{% else %}text-gray-700{% endif %}">
                                    {{ day }}
                                </span>
                                {% if day in month.lesson_markers %}
                                <div class="text-[8px] text-purple-600 font-bold leading-none">
                                    {{ month.lesson_markers[day] }}
                                </div>
                                {% endif %}
                            </div>
                            {% endif %}
                        </td>
                        {% endfor %}
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% endfor %}
    </div>
    
    <!-- Lesson Summary -->
    <div class="mt-4 flex flex-wrap gap-2">
        {% for lesson_num in range(1, 7) %}
        {% if lesson_num in data.lesson_dates %}
        <span class="bg-purple-100 text-purple-800 text-sm px-3 py-1 rounded-full">
            Lesson {{ lesson_num }}: {{ data.lesson_dates[lesson_num].strftime('%b %d, %Y') }}
        </span>
        {% endif %}
        {% endfor %}
    </div>
    </div>
    <!-- End Collapsible Calendar Section -->
    
    <!-- Quick Actions -->
    <div class="mt-4 flex gap-2">
        {% if data.current_lesson < 6 %}
        <form method="POST" action="{{ url_for('lessons.advance_lesson', site=data.site) }}" class="inline">
            <button type="submit" 
                    class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg text-sm"
                    onclick="return confirm('Advance {{ data.site }} to Lesson {{ data.current_lesson + 1 }}?')">
                ‚û°Ô∏è Advance to Lesson {{ data.current_lesson + 1 }}
            </button>
        </form>
        {% else %}
        <div class="bg-green-100 text-green-800 font-semibold py-2 px-4 rounded-lg text-sm">
            ‚úÖ All Lessons Complete
        </div>
        {% endif %}
        
        <details class="inline">
            <summary class="cursor-pointer text-blue-600 hover:text-blue-800 font-medium text-sm py-2 px-4">
                Set Manually
            </summary>
            <form method="POST" action="{{ url_for('lessons.set_lesson', site=data.site) }}" class="mt-2 flex gap-2 items-center">
                <select name="lesson" class="px-3 py-2 border border-gray-300 rounded-lg text-sm">
                    {% for i in range(1, 7) %}
                    <option value="{{ i }}" {% if i == data.current_lesson %}selected{% endif %}>
                        Lesson {{ i }}
                    </option>
                    {% endfor %}
                </select>
                <input type="date" name="start_date" 
                       value="{{ data.lesson_dates.get(data.current_lesson).strftime('%Y-%m-%d') if data.current_lesson in data.lesson_dates else '' }}"
                       class="px-3 py-2 border border-gray-300 rounded-lg text-sm">
                <button type="submit" class="bg-gray-600 hover:bg-gray-700 text-white font-semibold py-2 px-4 rounded-lg text-sm">
                    Update
                </button>
            </form>
        </details>
    </div>
</div>
{% endfor %}

{% if not lesson_data %}
<div class="text-center py-12">
    <p class="text-gray-500">No sites found. Add kids to create sites first.</p>
</div>
{% endif %}

<script>
function toggleCalendar(siteId) {
    const calendarDiv = document.getElementById('calendar-' + siteId);
    const icon = document.getElementById('icon-' + siteId);
    
    if (calendarDiv.style.display === 'none') {
        calendarDiv.style.display = 'block';
        icon.style.transform = 'rotate(0deg)';
    } else {
        calendarDiv.style.display = 'none';
        icon.style.transform = 'rotate(-90deg)';
    }
}
</script>

<style>
.calendar-section {
    display: block;
    transition: all 0.3s ease;
}
</style>
{% endblock %}
