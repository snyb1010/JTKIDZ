{% extends "base.html" %}

{% block title %}Lesson Management - JT KIDZ{% endblock %}

{% block content %}
<div class="mb-6">
    <h1 class="text-3xl font-bold text-gray-800">üìö Lesson Management</h1>
    <p class="text-gray-600">Track lesson start dates for all sites</p>
</div>

{% for data in lesson_data %}
<div class="bg-white rounded-lg shadow-md p-6 mb-6">
    <div class="flex justify-between items-center mb-4">
        <h2 class="text-2xl font-bold text-gray-800">{{ data.site }}</h2>
        <span class="bg-purple-100 text-purple-800 px-4 py-2 rounded-full font-bold">
            Current: Lesson {{ data.current_lesson }}
        </span>
    </div>
    
    <!-- Calendars Grid -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
        {% for month in data.months %}
        <div class="border border-gray-200 rounded-lg p-3">
            <h3 class="text-center font-bold text-gray-700 mb-2">{{ month.name }}</h3>
            <table class="w-full text-xs">
                <thead>
                    <tr class="text-gray-500">
                        <th class="text-center py-1">Su</th>
                        <th class="text-center py-1">Mo</th>
                        <th class="text-center py-1">Tu</th>
                        <th class="text-center py-1">We</th>
                        <th class="text-center py-1">Th</th>
                        <th class="text-center py-1">Fr</th>
                        <th class="text-center py-1">Sa</th>
                    </tr>
                </thead>
                <tbody>
                    {% for week in month.weeks %}
                    <tr>
                        {% for day in week %}
                        <td class="text-center py-1 relative">
                            {% if day == 0 %}
                            <span class="text-gray-300"></span>
                            {% else %}
                            <div class="relative">
                                <span class="{% if day in month.lesson_markers %}font-bold text-purple-600{% else %}text-gray-700{% endif %}">
                                    {{ day }}
                                </span>
                                {% if day in month.lesson_markers %}
                                <div class="text-[8px] text-purple-600 font-bold leading-none">
                                    {{ month.lesson_markers[day] }}
                                </div>
                                {% endif %}
                            </div>
                            {% endif %}
                        </td>
                        {% endfor %}
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% endfor %}
    </div>
    
    <!-- Lesson Summary -->
    <div class="mt-4 flex flex-wrap gap-2">
        {% for lesson_num in range(1, 7) %}
        {% if lesson_num in data.lesson_dates %}
        <span class="bg-purple-100 text-purple-800 text-sm px-3 py-1 rounded-full">
            Lesson {{ lesson_num }}: {{ data.lesson_dates[lesson_num].strftime('%b %d, %Y') }}
        </span>
        {% endif %}
        {% endfor %}
    </div>
    
    <!-- Quick Actions -->
    <div class="mt-4 flex gap-2">
        {% if data.current_lesson < 6 %}
        <form method="POST" action="{{ url_for('lessons.advance_lesson', site=data.site) }}" class="inline">
            <button type="submit" 
                    class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg text-sm"
                    onclick="return confirm('Advance {{ data.site }} to Lesson {{ data.current_lesson + 1 }}?')">
                ‚û°Ô∏è Advance to Lesson {{ data.current_lesson + 1 }}
            </button>
        </form>
        {% else %}
        <div class="bg-green-100 text-green-800 font-semibold py-2 px-4 rounded-lg text-sm">
            ‚úÖ All Lessons Complete
        </div>
        {% endif %}
        
        <details class="inline">
            <summary class="cursor-pointer text-blue-600 hover:text-blue-800 font-medium text-sm py-2 px-4">
                Set Manually
            </summary>
            <form method="POST" action="{{ url_for('lessons.set_lesson', site=data.site) }}" class="mt-2 flex gap-2 items-center">
                <select name="lesson" class="px-3 py-2 border border-gray-300 rounded-lg text-sm">
                    {% for i in range(1, 7) %}
                    <option value="{{ i }}" {% if i == data.current_lesson %}selected{% endif %}>
                        Lesson {{ i }}
                    </option>
                    {% endfor %}
                </select>
                <input type="date" name="start_date" 
                       value="{{ data.lesson_dates.get(data.current_lesson).strftime('%Y-%m-%d') if data.current_lesson in data.lesson_dates else '' }}"
                       class="px-3 py-2 border border-gray-300 rounded-lg text-sm">
                <button type="submit" class="bg-gray-600 hover:bg-gray-700 text-white font-semibold py-2 px-4 rounded-lg text-sm">
                    Update
                </button>
            </form>
        </details>
    </div>
</div>
{% endfor %}

{% if not lesson_data %}
<div class="text-center py-12">
    <p class="text-gray-500">No sites found. Add kids to create sites first.</p>
</div>
{% endif %}
{% endblock %}
