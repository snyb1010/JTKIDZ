{% extends "base.html" %}

{% block title %}Lesson Report - JT KIDZ{% endblock %}

{% block content %}
<div class="mb-6">
    <div class="flex justify-between items-center">
        <div>
            <h1 class="text-3xl font-bold text-gray-800">ðŸ“Š Lesson Attendance Report</h1>
            <p class="text-gray-600">Track attendance progress across all 6 lessons</p>
        </div>
        <a href="{{ url_for('reports.export_report', type='lesson', site=current_site, lesson=current_lesson) }}" 
           class="bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-6 rounded-lg">
            ðŸ“¥ Export to Excel
        </a>
    </div>
</div>

<!-- Filters -->
<div class="bg-white rounded-lg shadow-md p-6 mb-6">
    <form method="GET" class="flex flex-wrap gap-4">
        <div class="flex-1 min-w-[200px]">
            <label class="block text-sm font-medium text-gray-700 mb-1">Site</label>
            <select name="site" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                <option value="">All Sites</option>
                {% for site in sites %}
                <option value="{{ site }}" {% if site == current_site %}selected{% endif %}>{{ site }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="flex-1 min-w-[150px]">
            <label class="block text-sm font-medium text-gray-700 mb-1">Lesson</label>
            <select name="lesson" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                <option value="">All Lessons</option>
                {% for i in range(1, 7) %}
                <option value="{{ i }}" {% if current_lesson == i|string %}selected{% endif %}>Lesson {{ i }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="flex items-end">
            <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-6 rounded-lg">
                Filter
            </button>
        </div>
    </form>
</div>

<!-- Overall Progress Chart -->
<div class="bg-white rounded-lg shadow-md p-6 mb-6">
    <h2 class="text-xl font-bold text-gray-800 mb-4">Overall Attendance by Lesson</h2>
    <canvas id="overallChart" height="80"></canvas>
    
    <div class="mt-6 grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4">
        {% for lesson in overall_by_lesson %}
        <div class="text-center p-4 bg-gray-50 rounded-lg">
            <p class="text-sm text-gray-600">Lesson {{ lesson.lesson }}</p>
            <p class="text-2xl font-bold text-blue-600">{{ lesson.rate }}%</p>
            <p class="text-xs text-gray-500">{{ lesson.attendance }}/{{ lesson.total_kids }}</p>
        </div>
        {% endfor %}
    </div>
</div>

<!-- Lesson Details -->
{% for lesson_info in lesson_data %}
<div class="bg-white rounded-lg shadow-md p-6 mb-6">
    <h2 class="text-xl font-bold text-gray-800 mb-4">Lesson {{ lesson_info.lesson }}</h2>
    
    <!-- Site Progress Bars -->
    <div class="space-y-4">
        {% for site_data in lesson_info.sites %}
        <div class="border border-gray-200 rounded-lg p-4">
            <div class="flex justify-between items-center mb-2">
                <div class="flex items-center gap-2">
                    <h3 class="font-semibold text-gray-800">{{ site_data.site }}</h3>
                    {% if site_data.is_current %}
                    <span class="bg-purple-100 text-purple-800 text-xs px-2 py-1 rounded-full font-semibold">Current</span>
                    {% elif site_data.is_completed %}
                    <span class="bg-green-100 text-green-800 text-xs px-2 py-1 rounded-full font-semibold">Completed</span>
                    {% else %}
                    <span class="bg-gray-100 text-gray-600 text-xs px-2 py-1 rounded-full font-semibold">Upcoming</span>
                    {% endif %}
                </div>
                <span class="text-sm font-medium text-gray-600">
                    {{ site_data.attendance_count }}/{{ site_data.total_kids }} ({{ site_data.completion_rate }}%)
                </span>
            </div>
            <div class="w-full bg-gray-200 rounded-full h-4">
                <div class="h-4 rounded-full transition-all
                            {% if site_data.completion_rate >= 80 %}bg-green-500
                            {% elif site_data.completion_rate >= 50 %}bg-yellow-500
                            {% else %}bg-red-500{% endif %}"
                     style="width: {{ site_data.completion_rate }}%"></div>
            </div>
        </div>
        {% endfor %}
    </div>
    
    <!-- Lesson Chart -->
    <div class="mt-6">
        <canvas id="lesson{{ lesson_info.lesson }}Chart" height="60"></canvas>
    </div>
</div>
{% endfor %}

{% if not lesson_data %}
<div class="bg-white rounded-lg shadow-md p-12 text-center">
    <p class="text-gray-500 text-lg">No attendance data found for the selected filters.</p>
</div>
{% endif %}

{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>
    // Overall Chart
    const overallData = {{ overall_by_lesson | tojson }};
    const overallCtx = document.getElementById('overallChart').getContext('2d');
    new Chart(overallCtx, {
        type: 'bar',
        data: {
            labels: overallData.map(d => 'Lesson ' + d.lesson),
            datasets: [{
                label: 'Attendance Rate (%)',
                data: overallData.map(d => d.rate),
                backgroundColor: 'rgba(59, 130, 246, 0.8)',
                borderColor: 'rgb(59, 130, 246)',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            scales: {
                y: {
                    beginAtZero: true,
                    max: 100,
                    ticks: {
                        callback: function(value) {
                            return value + '%';
                        }
                    }
                }
            },
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const lesson = overallData[context.dataIndex];
                            return `${lesson.attendance}/${lesson.total_kids} kids (${lesson.rate}%)`;
                        }
                    }
                }
            }
        }
    });
    
    // Individual Lesson Charts
    const lessonData = {{ lesson_data | tojson }};
    lessonData.forEach(lesson => {
        const ctx = document.getElementById('lesson' + lesson.lesson + 'Chart').getContext('2d');
        new Chart(ctx, {
            type: 'horizontalBar',
            data: {
                labels: lesson.sites.map(s => s.site),
                datasets: [{
                    label: 'Attendance',
                    data: lesson.sites.map(s => s.attendance_count),
                    backgroundColor: lesson.sites.map(s => {
                        if (s.is_current) return 'rgba(168, 85, 247, 0.8)';
                        if (s.is_completed) return 'rgba(34, 197, 94, 0.8)';
                        return 'rgba(156, 163, 175, 0.8)';
                    }),
                    borderWidth: 1
                }]
            },
            options: {
                indexAxis: 'y',
                responsive: true,
                scales: {
                    x: {
                        beginAtZero: true,
                        ticks: {
                            stepSize: 5
                        }
                    }
                },
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const site = lesson.sites[context.dataIndex];
                                return `${site.attendance_count}/${site.total_kids} kids (${site.completion_rate}%)`;
                            }
                        }
                    }
                }
            }
        });
    });
</script>
{% endblock %}
